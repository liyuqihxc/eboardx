set(MCU_FAMILY STM32F1xx)
set(MCU_LINE STM32F103xB)
set(MCU_LINKER_SCRIPT STM32F103C8Tx_FLASH.ld)

# All relative to project root, as generated by STM32CubeMX.
set(CURRENT_PATH ${CMAKE_CURRENT_LIST_DIR})
set(CORE_DIR ${CURRENT_PATH}/Core)
set(CMSIS_DIR ${CURRENT_PATH}/Drivers/CMSIS)
set(DEVICE_DIR ${CURRENT_PATH}/Drivers/CMSIS/Device/ST/STM32F1xx)
set(HAL_DIR ${CURRENT_PATH}/Drivers/STM32F1xx_HAL_Driver)

# Look here for header files.
include_directories(${CORE_DIR}/Inc)
include_directories(${CMSIS_DIR}/Include)
include_directories(${DEVICE_DIR}/Include)
include_directories(${HAL_DIR}/Inc)

# For diagnostic tools like rtags.
# set(CMAKE_EXPORT_COMPILE_COMMANDS ON)

# Compile and link
set(MCU_FLAGS "-mcpu=cortex-m3 -mthumb ${FPU} ${FLOAT_ABI}")
set(COMMON_FLAGS "${MCU_FLAGS} -DUSE_HAL_DRIVER -D${MCU_LINE}")

set(CMAKE_C_FLAGS "${COMMON_FLAGS}")
set(CMAKE_CXX_FLAGS "${COMMON_FLAGS}")
set(CMAKE_EXE_LINKER_FLAGS "${MCU_FLAGS} --specs=nosys.specs -T \"${CURRENT_PATH}/${MCU_LINKER_SCRIPT}\" -Wl,--cref")

# Some trickery to get CMake to deal with our assembler code.
# set_property(SOURCE ${DEVICE_DIR}/Source/Templates/gcc/startup_stm32f103xb.s PROPERTY LANGUAGE C)

# The linker flag --gc-section keeps unused object code here from being linked.
add_executable(${CMAKE_PROJECT_NAME}.elf
  # ${CMAKE_SOURCE_DIR}/src/main.cc
  ${CORE_DIR}/Src/main.c
  ${CORE_DIR}/Src/stm32f1xx_it.c
  ${CORE_DIR}/Src/system_stm32f1xx.c
  ${CURRENT_PATH}/startup_stm32f103xb.s
  ${HAL_DIR}/Src/stm32f1xx_hal.c
  ${HAL_DIR}/Src/stm32f1xx_hal_cortex.c
  ${HAL_DIR}/Src/stm32f1xx_hal_can.c
  ${HAL_DIR}/Src/stm32f1xx_hal_dma.c
  ${HAL_DIR}/Src/stm32f1xx_hal_flash.c
  ${HAL_DIR}/Src/stm32f1xx_hal_flash_ex.c
  ${HAL_DIR}/Src/stm32f1xx_hal_gpio.c
  ${HAL_DIR}/Src/stm32f1xx_hal_i2c.c
  ${HAL_DIR}/Src/stm32f1xx_hal_pwr.c
  ${HAL_DIR}/Src/stm32f1xx_hal_rcc.c
  ${HAL_DIR}/Src/stm32f1xx_hal_rcc_ex.c
  ${HAL_DIR}/Src/stm32f1xx_hal_rtc.c
  ${HAL_DIR}/Src/stm32f1xx_hal_rtc_ex.c
  ${HAL_DIR}/Src/stm32f1xx_hal_tim.c
  ${HAL_DIR}/Src/stm32f1xx_hal_tim_ex.c
  ${HAL_DIR}/Src/stm32f1xx_hal_uart.c
)

# Generate assembly listing.
add_custom_command(
  TARGET ${CMAKE_PROJECT_NAME}.elf
  COMMAND "${CMAKE_OBJDUMP}"
  ARGS "-S" "${CMAKE_PROJECT_NAME}.elf" ">>" "${CMAKE_PROJECT_NAME}.lst"
)
